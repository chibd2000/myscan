# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-09-09 3:23

from core.data import gLogger
import ldap3
import asyncio


async def check_unauth(addr):
    # port就默认使用389，因为ldap查出来的端口是636，但是实际利用得用389端口
    try:
        ldap_server = ldap3.Server(host=addr.split(':')[0], port=389, allowed_referral_hosts=[('*', False)], get_info=ldap3.ALL, connect_timeout=30)
        ldap_conn = ldap3.Connection(ldap_server)
        if len(ldap_server.info.naming_contexts) > 0:
            for _ in ldap_server.info.naming_contexts:
                if ldap_conn.search(_, '(objectClass=inetOrgPerson)'):
                    gLogger.myscan_info('target maybe ldap unauth, {}'.format(addr))
                    return {'name': 'unauth', 'url': str(addr), 'software': 'ldap'}
    except Exception:
        pass


async def ldap_scan(addr):
    vul_list = []
    a = await check_unauth(addr)
    if a is not None:
        vul_list.append(a)
    return vul_list