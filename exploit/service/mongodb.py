# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-08-27 18:35
from async_timeout import timeout
from core.data import gLogger
import asyncio

async def check_unauth(addr):
    with timeout(5):
        reader, writer = await asyncio.open_connection(addr.split(':')[0], int(addr.split(':')[1]))
        data = bytes.fromhex('3a000000a741000000000000d40700000000000061646d696e2e24636d640000000000ffffffff130000001069736d6173746572000100000000')
        writer.write(data)
        result = await reader.read(1024)
        if b'ismaster' in result:
            getLogData = bytes.fromhex('480000000200000000000000d40700000000000061646d696e2e24636d6400000000000100000021000000026765744c6f670010000000737461727475705761726e696e67730000')
            writer.write(getLogData)
            result = await reader.read(1024)
            writer.close()
            if b'totalLinesWritten' in result:
                gLogger.myscan_info('Target maybe mongodb unauth, {}'.format(addr))
                return {'name': 'unauth', 'url': addr, 'software': 'mongodb'}


async def mongodb_scan(addr):
    vul_list = []
    a = await check_unauth(addr)
    if a is not None:
        vul_list.append(a)
    return vul_list
