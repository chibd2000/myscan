# coding=utf-8
# @Author   : zpchcbd HG team
# @Time     : 2021-08-27 18:34
from core.data import gLogger
from async_timeout import timeout
import asyncio


async def check_unauth(addr):
    with timeout(5):
        reader, writer = await asyncio.open_connection(addr.split(':')[0], int(addr.split(':')[1]))
        writer.write(b'stats\r\n')
        await writer.drain()
        result = await reader.read(1024)
        writer.close()
        if b"STAT version" in result:
            gLogger.myscan_info('target maybe memcache unauth, {}'.format(addr))
            return {'name': 'unauth', 'url': str(addr), 'software': 'memcache'}


async def memcache_scan(addr):
    vul_list = []
    a = await check_unauth(addr)
    if a is not None:
        vul_list.append(a)
    return vul_list
